---
title: ""
resource_files:
- dashboard_data/clinical.rds
- dashboard_data/kegg.rds
- dashboard_data/LD_ERPRneg.rds
- dashboard_data/LD_overall.rds
- dashboard_data/modules.rds
- dashboard_data/neighbor_ERPRneg.rds
- dashboard_data/neighbor_overall.rds
- dashboard_data/neighbors.rds
- dashboard_data/nmol.rds
- dashboard_data/oncosig.rds
- dashboard_data/pathways.rds
- dashboard_data/varComp_standardized_July27_nomeanvalues.rds
- dashboard_data/tf_spca_standardized_July27.rds
- dashboard_data/mirna_spca_standardized_July27.rds
- dashboard_data/tf_spca_key_standardized_July27.rds
- dashboard_data/mirna_spca_key_standardized_July27.rds
- dashboard_data/corlist_July27.rds
- dashboard_data/cancerabbrev.rds
- dashboard_data/refGene_keep.txt
- dashboard_data/top200.rds
- edge-dashboard-functions.R
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    theme: bootstrap
---

```{r global, include=FALSE}
library(flexdashboard)
library(rvest)
library(scales)
library(RColorBrewer)
library(data.table)
library(ggplot2)
library(plotly)
library(DT)
library(tidyr)
library(dplyr)
library(viridis)
library(mixOmics)
library(ComplexHeatmap)
library(circlize)
library(tokenizers)

for(a in c("pathways", "kegg", "neighbors", "modules", "oncosig",
           "LD_overall", "LD_ERPRneg", "neighbor_ERPRneg", "neighbor_overall",
           "clinical", "nmol")) {
  cat(a,"\n")
  tmp <- readRDS(paste0("dashboard_data/", a, ".rds"))
  assign(a, tmp)
}

rownames(nmol) <- c("rnaseq", "mirna", "cna", "methyl", "mut", "samples", "mirna_ga")
#all_values <- readRDS("dashboard_data/varComp_standardized_July27.rds") ## Memory 53, time 660
#saveRDS(all_values[,1:9], "dashboard_data/varComp_standardized_July27_nomeanvalues.rds") ## Memory 53, time 660
all_values <- readRDS("dashboard_data/varComp_standardized_July27_nomeanvalues.rds") ## Memory 53, time 660
top200_data  <- readRDS("dashboard_data/top200.rds")


#all_values <- fread("dashboard_data/varComp.csv") ## Memory 51, time 3620
#all_values <- read.table("dashboard_data/varComp.csv", nrows=501152, 
#                               stringsAsFactors=FALSE, ## Memory 99, time 3010 
#                               check.names=FALSE,
#                               colClasses=c(rep("character", 2), rep("numeric", 12)), sep=",") 
#all_values <- read.csv.raw("dashboard_data/varComp.csv") ## Memory 195, time 2460

TF_values <- readRDS("dashboard_data/tf_spca_standardized_July27.rds")
mir_values <- readRDS("dashboard_data/mirna_spca_standardized_July27.rds")
TF_key<- readRDS("dashboard_data/tf_spca_key_standardized_July27.rds")
mir_key <- readRDS("dashboard_data/mirna_spca_key_standardized_July27.rds")

cancerabbrev <- readRDS("dashboard_data/cancerabbrev.rds")
cor_list <- readRDS("dashboard_data/corlist_July27.rds")

cancer_choice <- sort(unique(all_values$cancer))
names(cancer_choice) <- cancerabbrev$V2[match(cancer_choice, cancerabbrev$V1)]
gene_names <- unique(all_values$gene)

refgene <- fread("dashboard_data/refGene_keep.txt")
all_values <- merge(all_values, refgene, all.X=TRUE, by="gene")

source("edge-dashboard-functions.R")
```

Welcome
===================================== 


<style type="text/css">
.chart-title {  /* chart_title  */
font-size: 25px;
font-family: Helvetica;
</style>


### Exploring drivers of gene expression in TCGA cancer genomes (EDGE in TCGA)
Andrea Rau, Michael Flister, Hallgeir Rui, and Paul Auer


<div style="width:450px; height=300px">
![](images/logos.png)
</div>
<br>

*EDGE in TCGA* is an application that facilitates an interactive exploration of the genetic and epigenetic drivers of gene expression in 17 different cancers included in The Cancer Genome Project (TCGA). By decomposing the variance of gene expression into parts attributable to methylation, copy number alterations, somatic mutations, miRNA abundance, transcription factor expression, and cis-genetic polymorphisms, we provide a powerful tool for exploring patterns of genome-wide regulation as well as shared and divergent regulatory mechanisms across a wide variety of cancers.

<br>

The results presented here are in whole or part based upon data generated by The Cancer Genome Atlas managed
by the NCI and NHGRI. Information about TCGA Research Network may be found at http://cancergenome.nih.gov.

<br>

**FAQ**

**1. How do I use the app?**

The app is organized into 4 primary groups of results:

  - In the *Genome-wide pan-cancer* tab, users can explore global genome-wide pan-cancer trends in molecular drivers of gene expression using (1) heatmaps of estimated variance components for either pre-defined gene sets (e.g. Kegg pathways, oncogenic signatures) or for a custom list of gene symbols; or (2) plots of the first two principal components of genomewide variance components for each individual source of molecular variation.
  - In the *Gene-wise pan-cancer* tab, users can zero in on the estimated molecular variance components for a specific gene across 17 different cancers.
  - In the *TF/miRNA contribution* tab, users may obtain plots and tables summarizing the contribution of specific transcription factors and miRNAs for a user-provided gene and cancer type.
  - In the *Single cancer results* tab, users may browse the sortable tables of estimated variance components within a specific cancer type, as well as relevant information concerning the sample sizes used with the analysis and corresponding clinical information. This tab additionally provides cancer-specific heatmaps of estimated variance components for pre-defined gene sets (e.g. Kegg pathways, oncogenic signatures). 
  
Throughout the app, download buttons are provided for tables and high-resolution graphics. If you use any of the results or figures generated by this app in a publication or presentation, please cite our work: Rau et al. (2017) Exploring drivers of gene expression in The Cancer Genome Atlas. *bioRxiv*, https://www.biorxiv.org/content/early/2017/12/02/227926.

**2. Which cancers are included?**

There are a total of 17 cancers: Skin cutaneous melanoma (SKCM), Kidney renal clear cell carcinoma (KIRC), Thyroid carcinoma (THCA), Sarcoma (SARC), Pheochromocytoma and paraganglioma (PCPG), Pancreatic adenocarcinoma (PAAD), Esophageal carcinoma (ESCA), Kidney renal papillary cell carcinoma (KIRP), Lung    adenocarcinoma (LUAD), Brain lower grade glioma (LGG), Prostate adenocarcinoma (PRAD), Head and neck squamous cell carcinoma (HNSC), Liver hepatocellular carcinoma (LIHC), Bladder urothelial cancer (BLCA), Stomach adenocarcinoma (STAD), Breast invasive carcinoma (BRCA), Cervical squamous cell carcinoma and endocervical adenocarcinoma (CESC). 

**3. Where can I find more information?**

A preprint is currently available on [bioRxiv](https://www.biorxiv.org/content/early/2017/12/02/227926). You can find additional information about TCGA at the [Genomic Data Commons](https://gdc.cancer.gov).

**4. Does EDGE in TCGA require login or registration?**

No, login and/or registration are not required. EDGE in TCGA is open-access.

**5. Who should I contact if I have questions about EDGE in TCGA?**

Please contact [Dr. Andrea Rau](http://www.andrea-rau.com) (andrea.rau@inra.fr) or [Dr. Paul Auer](http://people.uwm.edu/pauer)  (pauer@uwm.edu) if you have questions or experience any technical difficulties with the app.




Genome-wide pan-cancer
=====================================
Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
radioButtons("pancancerviz", label = h4(""), 
             choices = c("Heatmap", "PCA plot"), 
             selected = "Heatmap")
```
<br>

```{r}
uiOutput("showheatmapoptions0")
uiOutput("showheatmapoptions")
uiOutput("showPCAoptions")
uiOutput("showheatmapoptions2")
```

<br>

```{r}
uiOutput("showheatmapoptions3")
uiOutput("showPCAoptions2")
uiOutput("showheatmapoptions4")
```


<br> 

```{r}
panvizchoice <- reactive(as.character(input$pancancerviz))
PCA_source <- reactive(as.character(input$PCA_source))
heatmap_setchoose2 <- reactive(as.character(input$heatmap_setchoose2))
heatmap_settype2 <- reactive(as.character(input$heatmap_settype2))
heatmap_molsource <- reactive(as.character(input$heatmap_molsource))
myownlist <- reactive(as.character(input$myownlist))


downloadHandler(filename = function() {
  ifelse(input$pancancerviz == "PCA plot", 
         paste0('genomewide-pancancer-PCA-', input$PCA_source, '.pdf', sep=''),
         paste0('genomewide-pancancer-heatmap-', 
                ifelse(input$heatmap_settype2 == "Top 200", "Top200", 
                       ifelse(input$heatmap_settype2 == "Input my own list...", "custom", 
                       gsub(".", "_", input$heatmap_setchoose2, fixed=TRUE))), 
                '.pdf', sep=''))
}, content = function(file) {
  if(input$pancancerviz == "PCA plot") {
    pdf(file, width=10, height=7)
    tmp <- all_values[,c("gene", "cancer", PCA_source()), with=FALSE]
    tmp2 <- spread(tmp, key="cancer", value=PCA_source()) %>% dplyr::select(-gene)
    tmp2 <- tmp2[which(rowSums(is.na(tmp2)) == 0),]
    pca_analysis <- pca(t(tmp2))
    plotIndiv(pca_analysis, title="", cex=5)
    dev.off()
  }
  if(input$pancancerviz == "Heatmap") {
    pdf(file, width=8, height=7)
   
  if(heatmap_settype2() != "Top 200" & heatmap_settype2() != "Input my own list...") {
      if(heatmap_settype2() == "Kegg pathways") ind <- unlist(kegg[[heatmap_setchoose2()]])
      if(heatmap_settype2() == "Cancer gene neighborhoods") ind <- unlist(neighbors[[heatmap_setchoose2()]])
      if(heatmap_settype2() == "Cancer modules") ind <- unlist(modules[[heatmap_setchoose2()]])
      if(heatmap_settype2() == "Oncogenic signatures") ind <- unlist(oncosig[[heatmap_setchoose2()]])
      top200 <- FALSE
  }
  if(heatmap_settype2() == "Top 200") {
    ind <- 1
    top200 <- TRUE
  }
  if(heatmap_settype2() == "Input my own list...") {
    ind <- NULL
    if(length(myownlist())) {
#        ind <- strsplit(myownlist(), split=",", fixed=TRUE) %>% unlist()
      ind <- tokenize_words(myownlist(), lowercase=FALSE, strip_numeric=FALSE) %>% unlist()
    }
    top200 <- FALSE
  }
  set.seed(12345)
  h <- my_complexheatmap(all_values=all_values, ind=ind, 
                    molsource_choice = heatmap_molsource(),
                    top200=top200, rn=ifelse(heatmap_settype2() == "Input my own list...",
                                               TRUE, FALSE), top200_data=top200_data)
  print(h)
    
    dev.off()
  }},  contentType="application/pdf", outputArgs=list(label="Download plot"))
```


```{r}

output$showheatmapoptions0 <- renderUI({
  if(panvizchoice() == "Heatmap") {
    checkboxGroupInput("heatmap_molsource", label=h4("Source of molecular variation"),
                       choices = c("mut", "cna", "methyl", "mirna", "TF", "genetic"),
                       selected = c("mut", "cna", "methyl", "mirna", "TF", "genetic"))
  }
})
output$showheatmapoptions <- renderUI({
  if(panvizchoice() == "Heatmap") {
    selectInput("heatmap_settype2", label = h4("Gene set type"),
                choices = c(" ", "Top 200", names(pathways), "Input my own list..."), selected = " ")
  }
})
output$showheatmapoptions2 <- renderUI({
  if(panvizchoice() == "Heatmap" & heatmap_settype2() != "Top 200" & heatmap_settype2() != "Input my own list..." & heatmap_settype2() != " ") {
    mytest <- as.character(input$heatmap_settype2)
    selectInput('heatmap_setchoose2', h4('Gene set'), pathways[[mytest]], 
                selected = pathways[[mytest]][1])
  }
})
output$showPCAoptions <- renderUI({
  if(panvizchoice() == "PCA plot") {
    selectInput("PCA_source", label = h6("Select a source of molecular variation to visualize:"),
            choices = c("mut", "cna", "methyl", "mirna", "TF", "genetic"),
            selected = "TF", multiple=FALSE)
    }
})
output$showPCAoptions2 <- renderUI({
  if(panvizchoice() == "PCA plot") {
    tags$div(class="header", checked=NA,
             tags$h6("This plot represents the first two principal components for the genomewide variance components from a user-selected source of molecular variation for each of the 17 cancers included in this study. This allows a visualization of how cancers cluster with one another according to global patterns of how gene expression variation is decomposed into different molecular components."))
    }
})

output$showheatmapoptions3 <- renderUI({
  if(panvizchoice() == "Heatmap" & heatmap_settype2() != "Top 200" & heatmap_settype2() != "Input my own list..." & heatmap_settype2() != " ") {
      website <- read_html(paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",
                              heatmap_setchoose2()))
      temp <- html_nodes(website, ".lists4 td , th") %>% html_text()
      m <- matrix(c("Source", paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",
                                 heatmap_setchoose2()), temp[1:26]), ncol=2, byrow=TRUE)
      colnames(m) <- c("Field", "Description")
      htmlOutput("heatmap_geneset_description")
 #     tags$div(class="header", checked=NA,
#               tags$h5("See 'Single cancer results' tab for more details."))
    }
})

output$showheatmapoptions4 <- renderUI({
  if(panvizchoice() == "Heatmap" & heatmap_settype2() == "Input my own list...") {
    textInput("myownlist", label=h6("Enter list of gene symbols separated by spaces, commas, and/or semicolons (e.g. PTPN14,A1BG;MYL2 GATA3)"),
             value="") 
  }
})

output$heatmap_geneset_description <- renderText({
  website <- read_html(paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",
                              heatmap_setchoose2()))
  temp <- html_nodes(website, ".lists4 td , th") %>% html_text()
  m <- matrix(c("Source", paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",
                                 heatmap_setchoose2()), temp[1:26]), ncol=2, byrow=TRUE)
  str1 <- "<i>Brief gene set description:</i>"
  str2 <- "<i>See \'Single cancer results\' tab for more details.</i>"
  str1b <-  m[4,2]
  HTML(paste(str1, str1b, str2, sep='<br/><br/>'))
})

```


Column 
-----------------------------------------------------------------------
```{r}
uiOutput("heatmap_vs_PCA1")
uiOutput("heatmap_vs_PCA2")

ind_reactive <- reactive({
  tmp <- TRUE
  if(heatmap_settype2() != "Top 200" & heatmap_settype2() != "Input my own list..." & heatmap_settype2() != " ") {
    if(heatmap_settype2() == "Kegg pathways") ind <- unlist(kegg[[heatmap_setchoose2()]])
    if(heatmap_settype2() == "Cancer gene neighborhoods") 
      ind <- unlist(neighbors[[heatmap_setchoose2()]])
    if(heatmap_settype2() == "Cancer modules") ind <- unlist(modules[[heatmap_setchoose2()]])
    if(heatmap_settype2() == "Oncogenic signatures") 
      ind <- unlist(oncosig[[heatmap_setchoose2()]])
    if(sum(ind %in% gene_names)==0) tmp <- FALSE
  }
  if(heatmap_settype2() == "Input my own list...") {
    ind <- NULL
    if(length(myownlist())) {
 #     ind <- strsplit(myownlist(), split=",", fixed=TRUE) %>% unlist()
       ind <- tokenize_words(as.vector(myownlist()), lowercase=FALSE, strip_numeric=FALSE) %>% unlist()
    }
    if(sum(ind %in% gene_names) == 0) tmp <- FALSE
  }
  if(heatmap_settype2() == " ") {
    tmp <- FALSE
  }
  return(tmp)
})

output$heatmap_vs_PCA1 <- renderUI({
  if(panvizchoice() == "Heatmap") {
    if(ind_reactive() == TRUE) {
       plotOutput("panheatmapglobal", width=800, height=700)
    } else {
      h3(textOutput("pantext2"))
    }
  }
})
output$pantext2 <- renderText({ 
  "Please select a gene set to the left, or enter a list of valid gene symbols."
})

output$heatmap_vs_PCA2 <- renderUI({
  if(panvizchoice() == "PCA plot") {
    plotOutput("panPCA", width=1000, height=700)
  }
})


output$panheatmapglobal <- renderPlot({

    if(heatmap_settype2() != "Top 200" & heatmap_settype2() != "Input my own list...") {
      if(heatmap_settype2() == "Kegg pathways") ind <- unlist(kegg[[heatmap_setchoose2()]])
      if(heatmap_settype2() == "Cancer gene neighborhoods") ind <- unlist(neighbors[[heatmap_setchoose2()]])
      if(heatmap_settype2() == "Cancer modules") ind <- unlist(modules[[heatmap_setchoose2()]])
      if(heatmap_settype2() == "Oncogenic signatures") ind <- unlist(oncosig[[heatmap_setchoose2()]])
      top200 <- FALSE
  }
  if(heatmap_settype2() == "Top 200") {
    ind <- 1
    top200 <- TRUE
  }
  if(heatmap_settype2() == "Input my own list...") {
    ind <- NULL
    if(length(myownlist())) {
      ind <- tokenize_words(as.vector(myownlist()), lowercase=FALSE, strip_numeric=FALSE) %>% unlist()
    }
    top200 <- FALSE
  }
  shiny::validate(
    need(ind, "")
  )
  shiny::validate(
    need(heatmap_molsource(), "")
  )
  withProgress(message = 'Making plot...', value = 0, {
  set.seed(12345)
  if(length(heatmap_molsource()) & length(ind)) {
      my_complexheatmap(all_values=all_values, ind=ind, 
                    molsource_choice = heatmap_molsource(),
                    top200=top200, rn=ifelse(heatmap_settype2() == "Input my own list...",
                                               TRUE, FALSE),
                    top200_data=top200_data)
  }
})
})

output$panPCA <- renderPlot({
    withProgress(message = 'Making plot...', value = 0, {

  tmp <- all_values[,c("gene", "cancer", PCA_source()), with=FALSE]
  tmp2 <- spread(tmp, key="cancer", value=PCA_source()) %>% dplyr::select(-gene)
  tmp2 <- tmp2[which(rowSums(is.na(tmp2)) == 0),]
  pca_analysis <- pca(t(tmp2))
  pp <- plotIndiv(pca_analysis, title="", cex=5)$graph
  pp + theme(plot.margin=margin(t=0.5,r=0.5,l=0.5,b=1.5, unit="in"))
    })
})

```



Gene-wise pan-cancer
===================================== 
Inputs {.sidebar}
-----------------------------------------------------------------------
```{r}
textInput("gene33", label = h3("Gene symbol"), 
          value = "PTPN14")
#checkboxInput("suggestions", label = h6("Show auto-complete suggestions?"), 
#              value = FALSE, width = NULL)
```
e.g., PTPN14, A1BG, MYL2, GATA3

```{r}
#actionButton("go", "Make pan-cancer plots!")
```
<br>
```{r}
selectInput("cancersub", label = h4("Cancer subset"),
            choices = as.character(cancer_choice),
            selected = cancer_choice, multiple=TRUE)

cancersubset <- reactive({as.character(input$cancersub)})

downloadHandler(filename = function() {paste('genewise-pancancer-', gene(), '.pdf', sep='')},
                content = function(file) {
                  pdf(file, width=10, height=6, onefile=TRUE)
                    p <- my_dotplot(all_values, gene_choice=gene()) 
                    print(p)
                    my_newpheatmap(gene_selection = gene(), cancer_selection = cancersubset(), 
                                all_values=all_values, cancerabbrev=cancerabbrev, main = gene()) 
                     dev.off()
                }, 
                contentType="application/pdf", outputArgs=list(label="Download plots"))
```





Column {.tabset}
-----------------------------------------------------------------------
### Variance components heatmap {data-padding=25}
```{r}
gene <- reactive(as.character(input$gene33))

#suggestions <- reactive(as.integer(input$suggestions))
# # https://github.com/VizWizard/BoxPlotR.shiny/blob/master/server.R
# downloadHandler(filename = function() {paste('pancancer-', Sys.Date(), '.pdf', sep='')},
#                 content = function(file) {
#                   pdf(file, width=10, height=6, onefile=FALSE)
#                   my_pheatmap(gene_selection = gene(), cancer_selection = cancersubset(), 
#                               all_values=all_values, cancerabbrev=cancerabbrev, 
#                               main=paste0("Gene: ", gene()))
#                   dev.off()
#                   }, 
#                 contentType="application/pdf")
# renderPlot({
#   my_pheatmap(gene_selection = gene(), cancer_selection = cancersubset(), 
#               all_values=all_values, cancerabbrev=cancerabbrev) 
# }, res=105)


uiOutput("panheatmap")

output$panheatmap <- renderUI({
  # if(suggestions() == TRUE) {
  #   textOutput("sugg")
  # } else {
  if(!gene() %in% unique(all_values$gene)) {
    h3(textOutput("pantext"))
  } else {
    plotOutput("panheatmapplot")
  }
  # }
})

output$pantext <- renderText({ 
  "Please enter a valid gene symbol."
})
# output$sugg <- renderText({ 
#   if(nchar(gene()) < 2) print("Please keep typing...") else {
#       paste0(all_values$gene[which(startsWith(unique(all_values$gene), gene())==TRUE)],
#              collapse="; ")
#   }
# })
output$panheatmapplot <- renderPlot({
  shiny::validate(
    need(gene(), ""),
    need(cancersubset(), "Please enter a valid subset of cancers.")
  )
  my_newpheatmap(gene_selection = gene(), cancer_selection = cancersubset(), 
              all_values=all_values, cancerabbrev=cancerabbrev, main = gene()) 
}, res=105)
```


### Variance components dotplot {data-padding=25}

```{r}
uiOutput("pandotplot")

output$pandotplot <- renderUI({
  if(!gene() %in% unique(all_values$gene)) {
    h3(textOutput("pantext"))
  } else {
    plotlyOutput("pandotplotly")
  }
})
output$pandotplotly <- renderPlotly({
    shiny::validate(
    need(gene(), ""),
    need(cancersubset(), "Please enter a valid subset of cancers.")
  )
  g <- my_dotplot(all_values, gene_choice=gene()) 
  g2 <- ggplotly(g + theme(legend.position="none"), tooltip=c("cancer", "value", "type"))
  # y <- list(title = "Weighted sPCA loading")
  g2 
})

```





TF/miRNA contribution
=====================================
Inputs {.sidebar}
-----------------------------------------------------------------------
```{r}
selectInput("cancerTF", label = h3("Cancer"),
            choices = as.vector(cancer_choice),
            selected = "BRCA")

textInput("geneTF", label = h3("Gene symbol"), 
          value = "PTPN14")
#checkboxInput("suggestions", label = h6("Show auto-complete suggestions?"), 
#              value = FALSE, width = NULL)
```
e.g., PTPN14, A1BG, MYL2, GATA3

```{r}
downloadHandler(filename = function() {paste('TF+miRNA-', geneTF(), '-', cancerTF(), '.pdf', sep='')},
                content = function(file) {
                  pdf(file, width=10, height=6, onefile=TRUE)
                    p1 <- my_zoom(gene_selection=geneTF(), cancer_selection=cancerTF(), 
                       values=TF_values, type="TF", horiz=TRUE)
                    p2 <- my_zoom(gene_selection=geneTF(), cancer_selection=cancerTF(), 
                       values=mir_values, type="mirs", horiz=TRUE)
                    print(p1)
                    print(p2)
                  dev.off()
                }, 
                contentType="application/pdf", outputArgs=list(label="Download TF/miRNA plots"))
```
<br> 

```{r}
downloadHandler(filename = function() {paste('TF+miRNA-', geneTF(), '-', cancerTF(), '.csv', sep='')},
                content = function(file) {
                  ## Gather together TF results
                  sel <- TF_values[which(TF_values$gene == geneTF() & TF_values$cancer == cancerTF()),]
                  sel_list <- setNames(split(sel, seq(nrow(sel))), sel$cancer)
                  sel_list <- lapply(sel_list, function(x) {
                    tmp <- x[1,3]
                    colnames(x)[-c(1:3)] <- strsplit(TF_key[as.numeric(tmp),2], ";")$tfs
                    return(x)}
                  )
                  sel_list[is.na(sel_list)] <- 0
                  sel_list <- rbindlist(sel_list)
                  sel_list_tidy <- gather(sel_list, key=TF, value=loading, -cancer, -key, -gene) %>%
                    dplyr::select(-cancer, -gene, -key)
                  sel_list_tidy_TF <- sel_list_tidy
                  colnames(sel_list_tidy_TF) <- c("TF_or_miRNA", "weighted_loading")
                  ## Gather together mir results
                  sel <- mir_values[which(mir_values$gene == genemir() & mir_values$cancer == cancermir()),]
                  sel_list <- setNames(split(sel, seq(nrow(sel))), sel$cancer)
                  sel_list <- lapply(sel_list, function(x) {
                      tmp <- x[1,2]
                      colnames(x)[-c(1:3)] <- strsplit(mir_key[as.numeric(tmp),2], ";")$mirs
                    return(x)}
                  )
                  sel_list[is.na(sel_list)] <- 0
                  sel_list <- rbindlist(sel_list)
                  sel_list_tidy <- gather(sel_list, key=miRNA, value=loading, -cancer, -key, -gene) %>%
                    dplyr::select(-cancer, -gene, -key)
                  colnames(sel_list_tidy) <- c("TF_or_miRNA", "weighted_loading")
                  write.csv(x= rbind(sel_list_tidy_TF, sel_list_tidy), file=file, quote=FALSE, row.names=FALSE)
                }, 
                contentType="text/csv", outputArgs=list(label="Download TF/miRNA tables"))
```


Column {.tabset}
-----------------------------------------------------------------------
### TF overview {data-padding=20}
```{r}
cancerTF <- reactive(as.character(input$cancerTF))
geneTF <- reactive(as.character(input$geneTF))

uiOutput("panTF")

output$panTF <- renderUI({
  #if(suggestions() == TRUE) {
  #   textOutput("suggTF")
  # } else {
  if(!geneTF() %in% unique(all_values$gene)) {
    h3(textOutput("pantextTF"))
  } else {
    plotlyOutput("panTFplot")
  }
  #  }
})

output$pantextTF <- renderText({ 
  "Please enter a valid gene symbol to begin."
})
output$suggTF <- renderText({ 
  if(nchar(geneTF()) < 2) print("Please keep typing...") else {
    paste0(all_values$gene[which(startsWith(unique(all_values$gene), geneTF())==TRUE)],
           collapse="; ")
  }
})
output$panTFplot <- renderPlotly({
  withProgress(message = 'Making plot...', value = 0, {
    p <- my_zoom(gene_selection=geneTF(), cancer_selection=cancerTF(), 
                 values=TF_values, type="TF", horiz=TRUE)
    p2 <- ggplotly(p + ylab(" "), tooltip=c("TF", "loading"))
    p2 
  })
  
})
```

### TF browse {data-padding=20}
```{r}
renderDataTable({
  sel <- TF_values[which(TF_values$gene == geneTF() & TF_values$cancer == cancerTF()),]
  sel_list <- setNames(split(sel, seq(nrow(sel))), sel$cancer)
  type <- "TF"
  sel_list <- lapply(sel_list, function(x) {
    if(type=="TF") {
      tmp <- x[1,3]
      colnames(x)[-c(1:3)] <- strsplit(TF_key[as.numeric(tmp),2], ";")$tfs
    }
    if(type=="mirs") {
      tmp <- x[1,2]
      colnames(x)[-c(1:3)] <- strsplit(mir_key[as.numeric(tmp),2], ";")$mirs
    }
    return(x)}
  )
  sel_list[is.na(sel_list)] <- 0
  sel_list <- rbindlist(sel_list)
  sel_list_tidy <- gather(sel_list, key=TF, value=loading, -cancer, -key, -gene) %>%
    dplyr::select(-cancer, -gene, -key)
  DT::datatable(sel_list_tidy, rownames=FALSE,
                filter=list(position="top", clear=TRUE, plain=FALSE),
                caption=paste0("Weighted sPCA loadings"))

})
```


### miRNA overview {data-padding=20}

```{r}
cancermir <- reactive(as.character(input$cancerTF))
genemir <- reactive(as.character(input$geneTF))

uiOutput("panmir")

output$panmir <- renderUI({
  # if(suggestions() == TRUE) {
  #   textOutput("suggmir")
  # } else {
  if(!genemir() %in% unique(all_values$gene)) {
    h3(textOutput("pantextmir"))
  } else {
    plotlyOutput("panmirplot")
  }
  # }
})

output$pantextmir <- renderText({ 
  "Please enter a valid gene symbol to begin."
})

output$suggmir <- renderText({ 
  if(nchar(genemir()) < 2) print("Please keep typing...") else {
    paste0(all_values$gene[which(startsWith(unique(all_values$gene), genemir())==TRUE)],
           collapse="; ")
  }
})

output$panmirplot <- renderPlotly({
  
  withProgress(message = 'Making plot...', value = 0, {
    
    p <- my_zoom(gene_selection=genemir(), cancer_selection=cancermir(), 
                 values=mir_values, type="mirs", horiz=TRUE)
    p2 <- ggplotly(p + ylab(" "), tooltip=c("miRNA", "loading"))
    p2
  })
  
})

```

### miRNA browse {data-padding=20}
```{r}
renderDataTable({
  sel <- mir_values[which(mir_values$gene == genemir() & mir_values$cancer == cancermir()),]
  sel_list <- setNames(split(sel, seq(nrow(sel))), sel$cancer)
  type <- "mirs"
  sel_list <- lapply(sel_list, function(x) {
    if(type=="TF") {
      tmp <- x[1,3]
      colnames(x)[-c(1:3)] <- strsplit(TF_key[as.numeric(tmp),2], ";")$tfs
    }
    if(type=="mirs") {
      tmp <- x[1,2]
      colnames(x)[-c(1:3)] <- strsplit(mir_key[as.numeric(tmp),2], ";")$mirs
    }
    return(x)}
  )
  sel_list[is.na(sel_list)] <- 0
  sel_list <- rbindlist(sel_list)
  sel_list_tidy <- gather(sel_list, key=miRNA, value=loading, -cancer, -key, -gene) %>%
    dplyr::select(-cancer, -gene, -key)
  DT::datatable(sel_list_tidy, rownames=FALSE,
                filter=list(position="top", clear=TRUE, plain=FALSE),
                caption=paste0("Weighted sPCA loadings"))

})
```

Single cancer results
=====================================
Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput("cancersingle", label = h3("Cancer"),
            choices = as.vector(cancer_choice),
            selected = "BRCA")

radioButtons("singlecancerchoice", label = h4(""), 
             choices = c("Browse results", "Gene set analysis"), 
             selected = "Browse results")
```

<br>

```{r}
uiOutput("showgenesetoptions")
uiOutput("setchoose2")
uiOutput("setchoose2_plot")
```


```{r}
singlecancerchoice <- reactive(as.character(input$singlecancerchoice))
setchoose2 <- reactive(as.character(input$setchoose2))
settype2 <- reactive(as.character(input$settype2))
cancer <- reactive(as.character(input$cancersingle))

output$showgenesetoptions <- renderUI({
  if(singlecancerchoice() == "Gene set analysis") {
    selectInput("settype2", label = h4("Gene set type"),
                choices = names(pathways), selected = "Kegg pathways")
  }
})
output$setchoose2 <- renderUI({
  if(singlecancerchoice() == "Gene set analysis") {
    mytest <- as.character(input$settype2)
    selectInput('setchoose2', h4('Gene set'), pathways[[mytest]])
  }
})
output$setchoose2_plot <- renderUI({})
```
<br>


```{r}
downloadHandler(filename = function() {
  ifelse(singlecancerchoice() == "Browse results", paste('varianceComponents-fullResults-', cancer(), '.csv', sep=''),
         paste('geneset-heatmap-', cancer(), '-', gsub(".", "_", input$setchoose2, fixed=TRUE), '.pdf', sep=''))
  },
                content = function(file) {
                  if(singlecancerchoice() == "Browse results") {
                    sel <- all_values[, c("cancer", "gene", "chr", "strand", "tss", "mut", "cna", "mirna", "TF", 
                                      "methyl", "genetic", "residual")]
                    sel <- sel[which(sel$cancer == cancer()),]
                    sel <- sel[,-1]
                    write.csv(x=sel, file=file, quote=FALSE, row.names=FALSE)
                  }
                  if(singlecancerchoice() != "Browse results") {
                    if(settype2() == "Kegg pathways") ind <- unlist(kegg[[setchoose2()]])
                    if(settype2() == "Cancer gene neighborhoods") ind <- unlist(neighbors[[setchoose2()]])
                    if(settype2() == "Cancer modules") ind <- unlist(modules[[setchoose2()]])
                    if(settype2() == "Oncogenic signatures") ind <- unlist(oncosig[[setchoose2()]])
                    pdf(file, width=10, height=6, onefile=FALSE)
                    my_newpheatmap(gene_selection = ind, cancer_selection = cancer(),
                      all_values=all_values, cancerabbrev=cancerabbrev)
                    dev.off()
                  }
                })
```

<br>
<br>

```{r}
renderTable({
  # tmp <- "BRCA"
  tmp <- cancer()
  if(length(grep("_", tmp)) > 0) tmp <- unlist(strsplit(tmp, split="_", fixed=TRUE))[1]
  website <- paste0("http://www.cbioportal.org/study?id=", tolower(tmp), "_tcga_pub#summary")
  website2 <- paste0("http://firebrowse.org/?cohort=", tolower(tmp))
  
  
  Links <- c(paste0("<a href='",  website, "' target='_blank'>cBioPortal</a>"),
             paste0("<a href='",  website2, "' target='_blank'>Broad Firebrowse</a>"))
  data.frame(Links)
  #  m <- matrix(website)
  #  colnames(m) <- c("cBioPortal link")
  #  m
}, sanitize.text.function = function(x) x)
```


Column 
-----------------------------------------------------------------------
```{r}
uiOutput("browse_vs_genesets")

output$browse_vs_genesets <- renderUI({
  
  if(singlecancerchoice() == "Browse results") {
    fluidPage(
      tabsetPanel(
        tabPanel("Results", value = "sub3", dataTableOutput("browsetable")),
        tabPanel("Sample size", value = "sub4",  dataTableOutput("summarytable")),
        tabPanel("Clinical information", value = "sub5", verbatimTextOutput("clinicaltable"))
      )) 
  } else {
    fluidPage(
      tabsetPanel(
        tabPanel("Heatmap", value = "sub1", plotOutput("genesetheatmap", width=1000, height=700)),
        tabPanel("Description", value = "sub2", dataTableOutput("genesetdescription"))
      ))
  }
})

output$browsetable <- DT::renderDataTable({
  # sel <- all_values[cancer == "BRCA", list(gene, chr, tss, mut, cna, mirna, TF, methyl, genetic, residual)]
 #  sel <- all_values[cancer == cancer(), .(gene, chr, tss, mut, cna, mirna, TF, methyl, genetic, residual)]
  sel <- all_values[, c("cancer", "gene", "chr", "tss", "mut", "cna", "mirna", "TF", "methyl", 
                        "genetic", "residual")]
  sel <- sel[which(sel$cancer == cancer()),]

  ## Round to 3 decimals
  cols <- names(sel)[5:11]
  sel <- sel %>% mutate_at(cols, funs(round(.,3)))
  DT::datatable(sel[,-1], options=list(pageLength = 25), rownames=FALSE,
                filter=list(position="top", clear=TRUE, plain=FALSE),
                caption="Note: TSS locations shown in hg19 coordinates.")
})

output$summarytable <- DT::renderDataTable({
  tmp <- data.frame(Item = c("Cancer",
                             "Sample size", "RNA-seq", "Somatic non-silent mutations",
                             "Somatic copy number alterations", "Methylation",
                             "miRNA-seq"),
                    Description = c(cancer(),
                                    paste(nmol[which(rownames(nmol) == "samples"),
                                               which(colnames(nmol) == cancer())],
                                          "\n(complete Caucasian tumoral samples)"),
                                    paste(nmol[which(rownames(nmol) == "rnaseq"),
                                               which(colnames(nmol) == cancer())], "genes\n(nonzero values)"),
                                    paste(nmol[which(rownames(nmol) == "mut"),
                                               which(colnames(nmol) == cancer())],
                                          "genes\n(mutation observed in at least one individual)"),
                                    paste(nmol[which(rownames(nmol) == "cna"),
                                               which(colnames(nmol) == cancer())], 
                                          "genes\n(nonzero values)"),
                                    paste(nmol[which(rownames(nmol) == "methyl"),
                                               which(colnames(nmol) == cancer())],
                                          "representative probes in gene promoter regions"),
                                    paste(nmol[which(rownames(nmol) == "mirna"),
                                               which(colnames(nmol) == cancer())],
                                          "microRNAs\n(nonzero values)")),
                    Detail =  c(cancerabbrev[which(cancerabbrev$V1 == cancer()),2],
                                "", "Illumina HiSeq 2000 (RSEM values)",
                                "",
                                "Affymetrix Genome-Wide Human SNP Array 6.0 (aggregated at gene-level using CNTools)",
                                "Illumina Infinium HumanMethylation450 BeadChip",
                                "Illumina HiSeq 2000 / Illumina Genome Analyzer (RPMMM values)")
  )
  DT::datatable(tmp, options=list(pageLength = 25))
})

output$clinicaltable <- renderPrint({
  lapply(as.data.frame(clinical[[cancer()]]), summary)[-1]
})


output$genesetheatmap <- renderPlot({
  if(settype2() == "Kegg pathways") ind <- unlist(kegg[[setchoose2()]])
  if(settype2() == "Cancer gene neighborhoods") ind <- unlist(neighbors[[setchoose2()]])
  if(settype2() == "Cancer modules") ind <- unlist(modules[[setchoose2()]])
  if(settype2() == "Oncogenic signatures") ind <- unlist(oncosig[[setchoose2()]])
  shiny::validate(
    need(ind, "")
  )
  shiny::validate(
    need(cancer(), "")
  )
  my_newpheatmap(gene_selection = ind, cancer_selection = cancer(),
              all_values=all_values, cancerabbrev=cancerabbrev, rn=FALSE)
})

output$genesetdescription <- DT::renderDataTable({
  website <- read_html(paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",
                              setchoose2()))
  temp <- html_nodes(website, ".lists4 td , th") %>% html_text()
  m <- matrix(c("Source", paste0("http://software.broadinstitute.org/gsea/msigdb/cards/",
                                 setchoose2()), temp[1:26]), ncol=2, byrow=TRUE)
  colnames(m) <- c("Field", "Description")
  DT::datatable(m, options=list(pageLength = 25))
  
})

```





Acknowledgements
=====================================

This work was made possible by the availability of large-scale open-access data from The Cancer Genome Atlas, as well as the open-source programming language R. In particular, we have made use of several R packages to perform data analysis and construct this interactive dashboard, including the following:

- [mixOmics](http://mixomics.org)
- [shiny](https://shiny.rstudio.com)
- [flexdashboard](http://rmarkdown.rstudio.com/flexdashboard/index.html)
- [tidyverse](https://www.tidyverse.org)
- [plotly](https://plot.ly/d3-js-for-r-and-shiny-charts)
- [rvest](https://github.com/hadley/rvest)
- [ComplexHeatmap](https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html)
- [RColorBrewer](https://cran.r-project.org/web/packages/RColorBrewer/index.html)
- [viridis](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html)
- [data.table](https://cran.r-project.org/web/packages/data.table/index.html)
- [DT](https://rstudio.github.io/DT)
- [tokenizers](https://cran.r-project.org/web/packages/tokenizers/index.html)

<br>

Dr. Andrea Rau was supported by the [AgreenSkills+](https://www.agreenskills.eu) fellowship program, which received funding from the EU's Seventh Framework Program under grant agreement FP7-60939 (AgreenSkills+ contract). We thank the [UWM High Performance Computing (HPC) Service](http://uwm.edu/hpc) for computing resources used in this work.

<br>

The EDGE in TCGA resource is available under the GNU public license (GPL-3). If you use any of the results or figures generated by this app in a publication or presentation, please cite our work: Rau et al. (2017) Exploring drivers of gene expression in The Cancer Genome Atlas. *bioRxiv*, https://www.biorxiv.org/content/early/2017/12/02/227926.
